# Chat System Messages

This document describes system messages automatically created by the Messager service for chat room lifecycle events.

When using with the gateway, `/api/chat` is exposed as `/messager/chat`.

## Overview

System messages are stored in the same `SnChatMessage` table as regular chat messages and are delivered to room members via WebSocket (`messages.new` packet with a message payload).

These messages are informational:

- They are generated by the backend (not typed by users)
- They do not trigger push notifications
- They can be displayed inline in chat history like timeline events

## Message Types

| Type | Trigger | Content style |
| --- | --- | --- |
| `system.member.joined` | A member joins (community join, invite accept, rejoin) | `"{name} joined the chat."` |
| `system.member.left` | A member leaves or is removed | `"{name} left the chat."` or `"{name} was removed from the chat by {operator}."` |
| `system.chat.updated` | Chat room info is updated | `"{operator} updated chat info ({fields})."` |

## Triggers

### Member Joined

Generated when:

- `POST /api/chat/{roomId}/members/me` (community join / rejoin)
- `POST /api/chat/invites/{roomId}/accept` (accept invite)

### Member Left

Generated when:

- `DELETE /api/chat/{roomId}/members/me` (self leave)
- `DELETE /api/chat/{roomId}/members/{memberId}` (moderator/owner kick)

### Chat Updated

Generated when:

- `PATCH /api/chat/{id}`

Only emitted when at least one tracked field changed.

Tracked changes:

- `name`
- `description`
- `is_community`
- `is_public`
- `realm_id`
- `picture_id`
- `background_id`

## Payload Shape

All events use standard `SnChatMessage` fields (`id`, `type`, `chat_room_id`, `sender_id`, `content`, `meta`, timestamps).

### `system.member.joined` meta

```json
{
  "event": "member_joined",
  "member_id": "member-guid",
  "account_id": "account-guid"
}
```

### `system.member.left` meta

Self leave:

```json
{
  "event": "member_left",
  "member_id": "member-guid",
  "account_id": "account-guid",
  "reason": "left"
}
```

Removed by moderator/owner:

```json
{
  "event": "member_left",
  "member_id": "member-guid",
  "account_id": "account-guid",
  "operator_member_id": "operator-member-guid",
  "operator_account_id": "operator-account-guid",
  "reason": "removed"
}
```

### `system.chat.updated` meta

```json
{
  "event": "chat_info_updated",
  "changes": {
    "name": { "old": "Old Name", "new": "New Name" },
    "is_public": { "old": false, "new": true }
  }
}
```

## WebSocket Delivery

System messages are sent like normal new messages:

- Packet type: `messages.new`
- Packet data: serialized `SnChatMessage`

No push notifications are sent for these system messages.

## Client Recommendations

- Render these `type` values with a system/timeline UI instead of normal chat bubbles.
- Do not treat system messages as editable user messages.
- For `system.chat.updated`, read `meta.changes` to provide richer UI (for example: "Room name changed").

