# Chat System Messages

This document describes system messages automatically created by the Messager service for chat and call lifecycle events.

When using with the gateway, `/api/chat` is exposed as `/messager/chat`.

## Overview

System messages are stored in `SnChatMessage` and delivered to room members via WebSocket (`messages.new` packet with a message payload).

These messages are informational:

- Generated by backend flows (not typed by users)
- No push notification delivery
- Intended for timeline/system-event UI

## Message Types

| Type | Trigger | Content style |
| --- | --- | --- |
| `system.member.joined` | A member joins chat | `"{name} joined the chat."` |
| `system.member.left` | A member leaves chat or is removed | `"{name} left the chat."` / `"{name} was removed from the chat by {operator}."` |
| `system.chat.updated` | Chat room info is updated | `"{operator} updated chat info ({fields})."` |
| `system.e2ee.rotate_required` | Group E2EE membership changed | `"E2EE sender key rotation required."` |
| `system.call.member.joined` | A member joins call | `"{name} joined the call."` |
| `system.call.member.left` | A member leaves call or is removed | `"{name} left the call."` / `"{name} was removed from the call by {operator}."` |

## Triggers

### Chat Member Joined

Generated when:

- `POST /api/chat/{roomId}/members/me` (community join/rejoin)
- `POST /api/chat/invites/{roomId}/accept` (accept invite)

### Chat Member Left

Generated when:

- `DELETE /api/chat/{roomId}/members/me` (self leave)
- `DELETE /api/chat/{roomId}/members/{memberId}` (kick)

### Chat Updated

Generated when:

- `PATCH /api/chat/{id}`

Only emitted when tracked fields changed.

Tracked fields:

- `name`
- `description`
- `is_community`
- `is_public`
- `realm_id`
- `picture_id`
- `background_id`

### E2EE Rotation Required

Generated when group member set changes in E2EE sender-key rooms:

- `POST /api/chat/{roomId}/members/me` (join/rejoin)
- `POST /api/chat/invites/{roomId}/accept` (accept invite)
- `DELETE /api/chat/{roomId}/members/me` (self leave)
- `DELETE /api/chat/{roomId}/members/{memberId}` (remove member)

### Call Member Joined

Generated when:

- `GET /api/chat/realtime/{roomId}/join`

Emission condition:

- Server syncs provider participants before token response and emits only if caller was not already present in participant list.

### Call Member Left

Generated when:

- `DELETE /api/chat/realtime/{roomId}` (leave call)
- `POST /api/chat/realtime/{roomId}/kick/{targetAccountId}` (removed by moderator/owner)

Emission condition:

- Emitted when participant removal actually occurs in provider room.

## Payload Shape

All events use standard `SnChatMessage` fields (`id`, `type`, `chat_room_id`, `sender_id`, `content`, `meta`, timestamps).

### `system.member.joined` meta

```json
{
  "event": "member_joined",
  "member_id": "member-guid",
  "account_id": "account-guid"
}
```

### `system.member.left` meta

Self leave:

```json
{
  "event": "member_left",
  "member_id": "member-guid",
  "account_id": "account-guid",
  "reason": "left"
}
```

Removed by moderator/owner:

```json
{
  "event": "member_left",
  "member_id": "member-guid",
  "account_id": "account-guid",
  "operator_member_id": "operator-member-guid",
  "operator_account_id": "operator-account-guid",
  "reason": "removed"
}
```

### `system.chat.updated` meta

```json
{
  "event": "chat_info_updated",
  "changes": {
    "name": { "old": "Old Name", "new": "New Name" },
    "is_public": { "old": false, "new": true }
  }
}
```

### `system.e2ee.rotate_required` meta

```json
{
  "event": "e2ee_rotate_required",
  "room_id": "room-guid",
  "changed_member_id": "account-guid",
  "reason": "member_joined",
  "rotation_hint_epoch": 1740758400000
}
```

### `system.call.member.joined` meta

```json
{
  "event": "call_member_joined",
  "call_id": "call-guid",
  "member_id": "member-guid",
  "account_id": "account-guid"
}
```

### `system.call.member.left` meta

Self leave:

```json
{
  "event": "call_member_left",
  "reason": "left",
  "call_id": "call-guid",
  "member_id": "member-guid",
  "account_id": "account-guid"
}
```

Removed by moderator/owner:

```json
{
  "event": "call_member_left",
  "reason": "removed",
  "call_id": "call-guid",
  "member_id": "member-guid",
  "account_id": "account-guid",
  "operator_member_id": "operator-member-guid",
  "operator_account_id": "operator-account-guid"
}
```

## WebSocket Delivery

System messages are sent as normal message packets:

- Packet type: `messages.new`
- Packet data: serialized `SnChatMessage`

No push notifications are sent for these system messages.

## Client Recommendations

- Render system types with timeline/system-event UI.
- Do not treat system messages as editable user-authored content.
- Use `meta.event` and `meta.reason` for icon/label variants.
- For `system.chat.updated`, render details from `meta.changes`.

## Related Documentation

- [Chat Voice Messages API](./CHAT_VOICE_MESSAGES.md)
